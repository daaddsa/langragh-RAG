# 2-2. æ¥å£è®¾è®¡è¯´æ˜ä¹¦ (ç²¾ç®€ç‰ˆ)

## 1. å¼•è¨€

### 1.1 ç¼–å†™ç›®çš„
æœ¬æ–‡æ¡£å®šä¹‰äº†â€œæ™ºæœç ”æŠ¥åŠ©æ‰‹â€åç«¯æœåŠ¡ï¼ˆFastAPIï¼‰ä¸å‰ç«¯ç•Œé¢ï¼ˆStreamlitï¼‰ä¹‹é—´çš„äº¤äº’æ¥å£ã€‚

### 1.2 æ¶æ„è¯´æ˜
ä¸ºæ»¡è¶³å¿«é€Ÿå¼€å‘éœ€æ±‚ï¼Œé‡‡ç”¨ **Backend-for-Frontend (BFF)** æ¨¡å¼ã€‚
*   **åç«¯**ï¼šæä¾›æ ‡å‡†çš„ REST APIï¼Œå°è£… LangGraph çš„å¤æ‚é€»è¾‘ã€‚
*   **å‰ç«¯**ï¼šStreamlit é€šè¿‡ `requests` åº“è°ƒç”¨åç«¯ APIã€‚

## 2. API æ¥å£å®šä¹‰

### 2.1 èŠå¤©è¡¥å…¨ (Chat Completion)
*   **URL**: `/chat`
*   **Method**: `POST`
*   **Description**: æ ¸å¿ƒæ¥å£ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶è¿”å› Agent çš„å“åº”ã€‚
*   **Request Body**:
    ```json
    {
      "message": "AI Agentçš„æœ€æ–°è¶‹åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ",
      "session_id": "unique-session-id-123",
      "openai_api_key": "sk-...",
      "tavily_api_key": "tv-...",
      "base_url": "https://api.openai.com/v1", // å¯é€‰
      "model": "gpt-3.5-turbo" // å¯é€‰
    }
    ```
*   **Response** (Streaming):
    æ¥å£è¿”å› Text Event Stream (ç±»ä¼¼äº SSEï¼Œä½†ä¸åŒ…å«å®Œæ•´ event metadataï¼Œä»…ä¸º content chunk)ã€‚
    ```text
    ğŸ” æ­£åœ¨æ€è€ƒ...
    
    ğŸŒ æ­£åœ¨è”ç½‘æœç´¢ç›¸å…³ä¿¡æ¯...
    
    æ ¹æ®æœ€æ–°çš„æœç´¢ç»“æœï¼ŒAI Agent çš„è¶‹åŠ¿åŒ…æ‹¬...
    ```

### 2.2 ç”Ÿæˆ PDF (Generate PDF)
*   **URL**: `/pdf`
*   **Method**: `POST`
*   **Description**: æ ¹æ®å‰ç«¯ä¼ å…¥çš„ä¼šè¯å†å²ç”Ÿæˆ PDF æŠ¥å‘Šã€‚
*   **Request Body**:
    ```json
    {
      "session_id": "unique-session-id-123",
      "title": "æˆ‘çš„ç ”æŠ¥",
      "messages": [
        {"role": "user", "content": "é—®é¢˜1"},
        {"role": "assistant", "content": "å›ç­”1"}
      ]
    }
    ```
*   **Response**:
    *   Content-Type: `application/pdf`
    *   Header `Content-Disposition`: `attachment; filename*=UTF-8''<encoded_title>.pdf`
    *   Body: äºŒè¿›åˆ¶ PDF æ–‡ä»¶æµã€‚

### 2.3 å¥åº·æ£€æŸ¥ (Health Check)
*   **URL**: `/health`
*   **Method**: `GET`
*   **Response**: `{"status": "ok", "version": "1.0.0-lite"}`

## 3. å†…éƒ¨çŠ¶æ€æ¥å£ (LangGraph State)

è™½ç„¶ LangGraph è¿è¡Œåœ¨åç«¯å†…å­˜ä¸­ï¼Œä½†æˆ‘ä»¬éœ€è¦å®šä¹‰ State ç»“æ„ä»¥ä¾¿å¼€å‘äººå‘˜ç†è§£æ•°æ®æµã€‚

```python
class AgentState(TypedDict):
    # æ¶ˆæ¯å†å²ï¼ŒåŒ…å« HumanMessage, AIMessage, ToolMessage
    messages: Annotated[List[BaseMessage], operator.add]
    
    # æœç´¢ç»“æœç¼“å­˜ï¼ˆå¯é€‰ï¼ŒMVPä¸­ä¸»è¦ä¾èµ– messages ä¸­çš„ ToolMessageï¼‰
    # search_results: List[dict] 
```

## 4. é”™è¯¯å¤„ç†
è‹¥å‘ç”Ÿå¼‚å¸¸ï¼ˆå¦‚ 500 Internal Server Errorï¼‰ï¼Œåç«¯ä¼šè¿”å›çº¯æ–‡æœ¬é”™è¯¯ä¿¡æ¯æˆ– JSONï¼Œå‰ç«¯éœ€æ•è·å¼‚å¸¸å¹¶å±•ç¤ºç»™ç”¨æˆ·ã€‚
