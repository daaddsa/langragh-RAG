# 2-2. 接口设计说明书 (精简版)

## 1. 引言

### 1.1 编写目的
本文档定义了“智搜研报助手”后端服务（FastAPI）与前端界面（Streamlit）之间的交互接口。

### 1.2 架构说明
为满足快速开发需求，采用 **Backend-for-Frontend (BFF)** 模式。
*   **后端**：提供标准的 REST API，封装 LangGraph 的复杂逻辑。
*   **前端**：Streamlit 通过 `requests` 库调用后端 API。

## 2. API 接口定义

### 2.1 聊天补全 (Chat Completion)
*   **URL**: `/api/chat`
*   **Method**: `POST`
*   **Description**: 核心接口，负责处理用户消息并返回 Agent 的响应。
*   **Request Body**:
    ```json
    {
      "message": "AI Agent的最新趋势是什么？",
      "session_id": "unique-session-id-123",
      "openai_api_key": "sk-...",  // 可选，从前端透传
      "tavily_api_key": "tv-..."   // 可选
    }
    ```
*   **Response** (Streaming / SSE):
    为了支持打字机效果，接口返回 Server-Sent Events (SSE)。
    ```text
    event: metadata
    data: {"status": "searching", "query": "AI Agent trends 2025"}

    event: message
    data: 根据最新的搜索结果...

    event: end
    data: [DONE]
    ```

### 2.2 生成 PDF (Generate PDF)
*   **URL**: `/api/pdf`
*   **Method**: `POST`
*   **Description**: 根据 Session ID 生成 PDF 报告。
*   **Request Body**:
    ```json
    {
      "session_id": "unique-session-id-123",
      "title": "研报-20251215"
    }
    ```
*   **Response**:
    *   Content-Type: `application/pdf`
    *   Body: 二进制 PDF 文件流。

### 2.3 健康检查 (Health Check)
*   **URL**: `/health`
*   **Method**: `GET`
*   **Response**: `{"status": "ok", "version": "1.0.0-lite"}`

## 3. 内部状态接口 (LangGraph State)

虽然 LangGraph 运行在后端内存中，但我们需要定义 State 结构以便开发人员理解数据流。

```python
class AgentState(TypedDict):
    # 消息历史，包含 HumanMessage, AIMessage, ToolMessage
    messages: Annotated[List[BaseMessage], operator.add]
    
    # 搜索结果缓存，用于 PDF 生成时的引用回溯
    search_results: List[dict]
```

## 4. 错误处理
所有 API 在发生错误时返回如下 JSON 结构：
```json
{
  "error": true,
  "message": "API Key 无效，请检查配置。",
  "code": "AUTH_ERROR"
}
```
