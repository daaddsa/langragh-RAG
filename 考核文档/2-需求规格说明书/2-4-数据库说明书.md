# 2-4. 数据库说明书 (精简版)

## 1. 引言
由于本项目简化为单机/单会话应用，数据库设计主要用于持久化LangGraph的运行状态（Checkpoints），以便实现多轮对话的记忆功能。

## 2. 数据库选型
*   **Database**: SQLite (嵌入式数据库，无需单独安装Server)
*   **Driver**: `aiosqlite` (异步驱动)

## 3. 表结构设计

本项目主要依赖 **LangGraph** 内置的 `SqliteSaver` 自动管理的表结构，主要包含以下核心表：

### 3.1 Checkpoints (自动管理)
用于存储每次对话后的状态快照。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| thread_id | TEXT | 会话唯一标识 (Primary Key) |
| thread_ts | TEXT | 时间戳/版本号 (Primary Key) |
| parent_ts | TEXT | 父节点时间戳 |
| checkpoint | BLOB | 序列化的状态数据 (Pickle) |
| metadata | TEXT | 元数据 (JSON) |

### 3.2 Checkpoint_Writes (自动管理)
用于存储状态更新时的写入操作。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| thread_id | TEXT | 会话ID |
| thread_ts | TEXT | 时间戳 |
| task_id | TEXT | 任务ID |
| idx | INTEGER | 索引 |
| channel | TEXT | 通道名称 (如 'messages') |
| type | TEXT | 数据类型 |
| value | BLOB | 写入的值 |

## 4. 数据流转
1.  用户发送消息 -> 后端接收。
2.  LangGraph 执行节点逻辑。
3.  每一步执行后，LangGraph 自动将 State 序列化并 `INSERT` 到 `Checkpoints` 表。
4.  下一轮对话时，LangGraph 根据 `thread_id` `SELECT` 最新的 `checkpoint` 恢复上下文。

## 5. 备份与恢复
由于数据存储在本地文件 `database.sqlite` 中，备份只需复制该文件即可。
