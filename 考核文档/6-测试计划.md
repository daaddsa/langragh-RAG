# 6. 测试计划 (Test Plan)

## 1. 引言

### 1.1 编写目的
本文档旨在为“智搜研报助手”项目制定详细的测试策略和计划，确保系统满足《需求规格说明书》中定义的核心功能（LangGraph 编排、实时搜索、PDF 导出）及非功能需求。

### 1.2 测试范围
*   **核心功能测试**：智能对话路由、联网搜索准确性、上下文记忆、PDF 生成。
*   **接口测试**：`/chat` 流式响应、`/pdf` 文件下载。
*   **非功能测试**：兼容性（中文字体）、健壮性（API 异常处理）。

## 2. 测试环境

*   **硬件**：Windows 10/11 PC (开发机)。
*   **软件**：Python 3.10+, Chrome/Edge 浏览器。
*   **依赖**：OpenAI API Key, Tavily API Key, `simsun.ttc` 字体文件。

## 3. 测试策略

采用 **黑盒测试** 为主，辅以部分 **接口自动化测试**。

1.  **单元测试 (Unit Testing)**：针对 `pdf_service.py` 等独立模块进行测试。
2.  **集成测试 (Integration Testing)**：测试前端 Streamlit 与后端 FastAPI 的交互。
3.  **系统测试 (System Testing)**：模拟真实用户场景，进行端到端 (E2E) 测试。

## 4. 测试用例 (Test Cases)

### 4.1 智能对话与路由 (LangGraph)

| 用例ID | 测试场景 | 输入示例 | 预期结果 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| TC-01 | **普通闲聊 (无需搜索)** | “你好，请介绍一下你自己。” | Agent 直接回复，不调用搜索工具；响应速度 < 3s。 | P0 |
| TC-02 | **实时搜索 (需要搜索)** | “今天北京的天气怎么样？” | Agent 识别意图 -> 调用 Tavily -> 返回包含具体天气数据的回答。 | P0 |
| TC-03 | **知识问答 (混合场景)** | “解释一下 RAG 技术。” | Agent 可能直接回答或搜索补充，内容准确清晰。 | P1 |
| TC-04 | **多轮对话 (上下文)** | Q1: “谁是埃隆·马斯克？”<br>Q2: “他管理哪些公司？” | Q2 的回答能正确指代 Q1 中的“他”，列出 Tesla, SpaceX 等。 | P0 |

### 4.2 PDF 导出功能

| 用例ID | 测试场景 | 前置条件 | 预期结果 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| TC-05 | **生成 PDF (英文)** | 有一段英文对话历史 | 下载成功，PDF 内容完整，无乱码。 | P1 |
| TC-06 | **生成 PDF (中文)** | 有一段中文对话历史 | 下载成功，**中文显示正常**（无方框/乱码），排版整齐。 | P0 |
| TC-07 | **长文本导出** | 对话历史超过 5 轮 | PDF 自动分页，内容不丢失。 | P1 |
| TC-08 | **空历史导出** | 清空对话后点击导出 | 提示“暂无对话内容”或生成仅含标题的 PDF（不报错）。 | P2 |

### 4.3 异常处理与健壮性

| 用例ID | 测试场景 | 操作步骤 | 预期结果 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| TC-09 | **API Key 无效** | 输入错误的 OpenAI Key | 界面提示认证错误，程序不崩溃。 | P1 |
| TC-10 | **搜索无结果** | 搜索极生僻关键词 | Agent 提示未找到相关信息，尝试用自身知识回答。 | P2 |
| TC-11 | **后端服务未启动** | 关闭后端，操作前端 | 前端提示“连接错误”或“API 请求超时”。 | P1 |

## 5. 接口测试脚本 (Python 示例)

```python
import requests
import json

BASE_URL = "http://localhost:8000"

def test_health():
    resp = requests.get(f"{BASE_URL}/health")
    assert resp.status_code == 200
    print("Health Check: PASS")

def test_chat_stream():
    payload = {
        "message": "Hello",
        "session_id": "test-001",
        "openai_api_key": "sk-xxx", # 需替换为有效 Key 或 Mock
        "tavily_api_key": "tv-xxx"
    }
    # 仅测试接口连通性，实际 Key 需有效
    try:
        with requests.post(f"{BASE_URL}/chat", json=payload, stream=True) as r:
            assert r.status_code == 200
            print("Chat Stream: PASS")
    except Exception as e:
        print(f"Chat Stream: FAIL ({e})")

def test_pdf_gen():
    payload = {
        "session_id": "test-001",
        "title": "Test Report",
        "messages": [
            {"role": "user", "content": "Test Q"},
            {"role": "assistant", "content": "Test A"}
        ]
    }
    resp = requests.post(f"{BASE_URL}/pdf", json=payload)
    assert resp.status_code == 200
    assert resp.headers["Content-Type"] == "application/pdf"
    assert len(resp.content) > 0
    print("PDF Gen: PASS")

if __name__ == "__main__":
    test_health()
    # test_chat_stream() 
    test_pdf_gen()
```

## 6. 验收标准 (Acceptance Criteria)

1.  **功能完备**：所有 P0 级测试用例通过。
2.  **无严重 Bug**：无 Crash、无页面卡死、无中文乱码。
3.  **文档齐全**：包含测试报告（简版）。
